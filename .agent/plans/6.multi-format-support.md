# Module 6: Multi-Format Support

## Complexity: ✅ Simple

## Context

The ingestion pipeline currently only handles UTF-8 text formats (`.txt`, `.md`, `.csv`, `.json`). The bottleneck is a single line in `service.py`: `text = file_bytes.decode("utf-8")`. Everything downstream (chunking, metadata extraction, embedding, record manager) operates on a plain `str` and needs no changes. Module 6 replaces that line with a format-aware dispatcher that adds PDF, DOCX, and HTML support.

## Architecture

**Single dispatch function.** New module `backend/app/ingestion/extractors.py` with one public function `extract_text(file_bytes, mime_type, filename) -> str` that maps MIME types to private extraction functions via a dict. No class hierarchies or plugin systems.

**Dependencies:** `pypdf` (PDF), `python-docx` (DOCX), `beautifulsoup4` (HTML). All pure-Python, no system library requirements.

---

## Tasks

### Task 1: Add extraction dependencies
**Modify** `backend/requirements.txt`
- Add `pypdf`, `python-docx`, `beautifulsoup4`
- **Validate:** `pip install -r requirements.txt && python -c "import pypdf; import docx; import bs4; print('OK')"`

### Task 2: Create text extractor module
**Create** `backend/app/ingestion/extractors.py`
- `_extract_text_utf8(file_bytes, filename)` — `file_bytes.decode("utf-8")` (existing behavior)
- `_extract_pdf(file_bytes, filename)` — `pypdf.PdfReader` + `io.BytesIO`, iterate pages, join with `"\n\n"`. Raise `ValueError` if no text extracted (scanned/image-only PDF)
- `_extract_docx(file_bytes, filename)` — `docx.Document(io.BytesIO(...))`, extract paragraphs + table cells, join with `"\n\n"`
- `_extract_html(file_bytes, filename)` — decode UTF-8 (fallback latin-1), `BeautifulSoup(html, "html.parser")`, remove `<script>/<style>/<nav>/<footer>/<header>` tags, `get_text(separator="\n", strip=True)`, collapse blank lines
- `_EXTRACTORS` dict mapping MIME types to functions
- `extract_text(file_bytes, mime_type, filename) -> str` — public dispatcher, raises `ValueError` on unsupported type or empty result
- **Validate:** `python -c "from app.ingestion.extractors import extract_text; print('OK')"`

### Task 3: Wire extractor into ingestion service
**Modify** `backend/app/ingestion/service.py`
- Import `extract_text` from `app.ingestion.extractors`
- Expand `ALLOWED_MIME_TYPES` to include `"application/pdf"`, `"application/vnd.openxmlformats-officedocument.wordprocessingml.document"`, `"text/html"`
- Add `mime_type: str = "text/plain"` parameter to `process_document()`
- Replace `text = file_bytes.decode("utf-8")` with `text = extract_text(file_bytes, mime_type, filename)`
- Remove the empty-file check immediately after (extractor already raises on empty)

### Task 4: Update router for new formats
**Modify** `backend/app/ingestion/router.py`
- Expand `_EXT_TO_MIME` with: `".pdf": "application/pdf"`, `".docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document"`, `".html": "text/html"`, `".htm": "text/html"`
- Update error message to list all extensions: `.txt, .md, .csv, .json, .pdf, .docx, .html`
- Pass `mime_type` as 5th arg to `process_document`: `background_tasks.add_task(process_document, doc_id, user.id, storage_path, file.filename, mime_type)`

### Task 5: Update frontend file upload
**Modify** `frontend/src/components/documents/FileUpload.tsx`
- Expand `ACCEPTED_TYPES`: add `"application/pdf": [".pdf"]`, `"application/vnd.openxmlformats-officedocument.wordprocessingml.document": [".docx"]`, `"text/html": [".html", ".htm"]`
- Update error message (line 48): `"Unsupported file type. Allowed: .txt, .md, .csv, .json, .pdf, .docx, .html"`
- Update help text (line 77): `"Supported: .txt, .md, .csv, .json, .pdf, .docx, .html (max 10MB)"`

### Task 6: Update PROGRESS.md
**Modify** `PROGRESS.md` — mark Module 6 tasks

---

## Files Summary

| File | Action |
|------|--------|
| `backend/requirements.txt` | Modify |
| `backend/app/ingestion/extractors.py` | **Create** |
| `backend/app/ingestion/service.py` | Modify |
| `backend/app/ingestion/router.py` | Modify |
| `frontend/src/components/documents/FileUpload.tsx` | Modify |
| `PROGRESS.md` | Modify |

No SQL migrations. No new frontend components. Chunking, metadata, embeddings, record manager, retrieval — all unchanged.

---

## Verification
1. Install deps: `pip install -r requirements.txt`
2. Regression: upload a `.txt` file, confirm it still processes to "completed"
3. Upload a PDF — verify document status reaches "completed", chunks are created, metadata is extracted
4. Upload a DOCX — same verification
5. Upload an HTML file — verify script/style content is NOT in chunks, body text IS present
6. Frontend: verify dropzone shows updated format list and accepts .pdf/.docx/.html drag-and-drop
