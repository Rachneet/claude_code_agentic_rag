# Module 1: App Shell + Observability

ğŸ”´ **Complex** -- 12 tasks, broken into individually manageable steps

**Delivers:** Auth (email/password), Chat UI with multiple threads, HuggingFace Inference streaming via SSE, thread/message persistence with RLS, LangSmith tracing

---

## Task 1: Supabase Project Setup + Database Schema
âœ… Simple

Create database schema and env templates. User runs SQL in Supabase SQL Editor.

**Create:**
- `backend/supabase/migrations/001_initial_schema.sql`
- `backend/.env.example`
- `frontend/.env.example`

**Schema:**
```sql
-- threads: id (uuid pk), user_id (fk auth.users), title, created_at, updated_at
-- messages: id (uuid pk), thread_id (fk threads cascade), user_id (fk auth.users), role (user|assistant), content, created_at
-- Indexes on user_id, thread_id, updated_at, created_at
-- RLS: 4 policies per table (select/insert/update/delete) -- auth.uid() = user_id
-- Trigger: auto-update updated_at on threads
```

**Validation:** Tables visible in Supabase Table Editor, RLS shield icons present, 4 policies per table in Authentication > Policies

---

## Task 2: Backend Scaffolding (Python + FastAPI)
âœ… Simple

Create venv, install deps, set up FastAPI app shell with CORS and health endpoint.

**Create:**
- `backend/requirements.txt` -- fastapi, uvicorn[standard], python-dotenv, pydantic, pydantic-settings, supabase, httpx, huggingface-hub, sse-starlette, PyJWT, langsmith
- `backend/app/__init__.py`
- `backend/app/main.py` -- FastAPI app, CORS (localhost:5173), `/health` endpoint, LangSmith env var setup
- `backend/app/config.py` -- Pydantic `Settings` class (all env vars, model default `Qwen/Qwen3-30B-A3B-Instruct-2507`)
- `backend/app/auth/__init__.py`
- `backend/app/chat/__init__.py`
- `backend/app/llm/__init__.py`
- `backend/app/db/__init__.py`
- `backend/app/models/__init__.py`

**Validation:** `curl http://localhost:8000/health` returns `{"status":"ok"}`

---

## Task 3: Supabase Client + JWT Auth Dependency
âš ï¸ Medium

Backend uses `service_role_key` (bypasses RLS, filters by user_id in queries). JWT verified locally with PyJWT (HS256, audience=authenticated).

**Create:**
- `backend/app/db/supabase.py` -- Supabase client init with service role key
- `backend/app/models/schemas.py` -- Pydantic models: User, ThreadCreate, ThreadUpdate, ThreadResponse, MessageResponse, ChatRequest
- `backend/app/auth/dependencies.py` -- `get_current_user` dependency: extracts Bearer token, decodes JWT, returns `User(id=sub_claim)`. Raises 401 on expired/invalid.

**Validation:** Protected endpoint rejects missing/invalid/expired tokens with 401

---

## Task 4: Frontend Scaffolding + Auth UI
âš ï¸ Medium

Vite + React + TypeScript + Tailwind + shadcn/ui. Supabase JS client for auth. Login/Signup tabs.

**Setup commands:**
```bash
npm create vite@latest frontend -- --template react-ts
npm install @supabase/supabase-js
npm install -D @tailwindcss/vite
npx shadcn@latest init
npx shadcn@latest add button input label card tabs
```

**Create:**
- `frontend/src/lib/supabase.ts` -- Supabase client (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
- `frontend/src/lib/api.ts` -- `apiFetch()` helper: gets session token, adds Authorization header
- `frontend/src/types/index.ts` -- Thread, Message interfaces
- `frontend/src/contexts/AuthContext.tsx` -- AuthProvider with onAuthStateChange, provides user/session/signUp/signIn/signOut
- `frontend/src/components/auth/LoginForm.tsx` -- Email + password login
- `frontend/src/components/auth/SignupForm.tsx` -- Email + password signup
- `frontend/src/components/auth/AuthPage.tsx` -- Tabs container (Login | Signup)
- `frontend/src/components/layout/AppLayout.tsx` -- Main layout shell (sidebar + content)
- `frontend/src/components/layout/Header.tsx` -- App title + logout button
- `frontend/src/App.tsx` -- AuthProvider wrapper, routes to AuthPage or AppLayout
- `frontend/src/main.tsx`, `frontend/src/index.css`

**Modify:** `vite.config.ts` (path alias, tailwind plugin), `tsconfig.json` / `tsconfig.app.json` (baseUrl, paths)

**Validation:** Sign up at localhost:5173, user appears in Supabase Dashboard > Auth > Users, login works, logout returns to auth page, refresh preserves session

---

## Task 5: Thread Management (Backend REST)
âš ï¸ Medium

CRUD endpoints for threads + message listing. All scoped to authenticated user.

**Create:**
- `backend/app/chat/router.py` -- APIRouter with:
  - `GET /api/threads` -- list user's threads (order by updated_at desc)
  - `POST /api/threads` -- create thread
  - `PATCH /api/threads/{id}` -- rename thread
  - `DELETE /api/threads/{id}` -- delete (cascade to messages)
  - `GET /api/threads/{id}/messages` -- list messages (verify thread ownership first)

**Modify:** `backend/app/main.py` -- register chat router

**Validation:** curl with valid JWT: create thread, list threads, verify in Supabase Table Editor

---

## Task 6: HuggingFace Inference Client + LangSmith Tracing
âš ï¸ Medium

HF InferenceClient wrapper with streaming + LangSmith `@traceable`.

**Create:**
- `backend/app/llm/huggingface.py`:
  - `SYSTEM_PROMPT` -- default system message
  - `chat_completion()` -- non-streaming (for title generation), `@traceable(run_type="llm")`
  - `chat_completion_stream()` -- streaming generator, yields content tokens

**Validation:** Run test script that calls both functions, verify tokens stream in real-time, check LangSmith dashboard for traces with correct input/output

---

## Task 7: Chat Service + SSE Endpoint
âš ï¸ Medium

Core chat flow: save user msg -> build history -> stream LLM response via SSE -> save assistant msg -> auto-title on first message.

**SSE protocol:**
- `event: token` / `data: {"content": "..."}` -- individual tokens
- `event: done` / `data: {"message_id": "..."}` -- stream complete
- `event: error` / `data: {"detail": "..."}` -- error

**Create:**
- `backend/app/chat/service.py`:
  - `save_message()` -- insert message to DB
  - `get_thread_messages()` -- fetch history for thread
  - `generate_thread_title()` -- LLM generates short title from first message, `@traceable`
  - `stream_chat_response()` -- full orchestration, async generator yielding SSE events, `@traceable`

**Modify:** `backend/app/chat/router.py` -- add `POST /api/chat` endpoint, returns `EventSourceResponse`

**Validation:** `curl -N` to SSE endpoint, see streaming tokens, verify messages saved in DB, verify auto-generated thread title, check LangSmith traces

---

## Task 8: Thread Sidebar (Frontend)
âš ï¸ Medium

Sidebar component: thread list, new chat button, select/delete threads.

**Setup:** `npx shadcn@latest add scroll-area tooltip`

**Create:**
- `frontend/src/components/chat/ThreadSidebar.tsx` -- fetches threads, displays sorted list, new chat button, delete on hover, active highlight, `onSelectThread` callback

**Validation:** Create multiple threads, switch between them, delete works, refresh persists

---

## Task 9: Chat View (Frontend -- Messages + Input + Streaming)
âš ï¸ Medium

Message display + input + SSE stream consumption. State machine: idle -> sending -> streaming.

**Setup:** `npx shadcn@latest add textarea avatar`

**Create:**
- `frontend/src/components/chat/MessageList.tsx` -- user msgs right-aligned, assistant msgs left-aligned, streaming message support, auto-scroll, empty state
- `frontend/src/components/chat/MessageInput.tsx` -- textarea, Enter to send (Shift+Enter newline), disabled while streaming
- `frontend/src/components/chat/ChatView.tsx` -- composes MessageList + MessageInput, manages chat state machine, loads messages on thread change, consumes SSE stream

**Modify:** `frontend/src/lib/api.ts` -- add `apiStreamChat()` using fetch + ReadableStream to parse SSE events

**Validation:** Send message, see streaming response, conversation history maintained, messages persist on refresh

---

## Task 10: Full Layout Integration
âœ… Simple

Wire ThreadSidebar + ChatView in AppLayout. Manage selected thread state.

**Layout:** Header (full width) | Sidebar (~280px fixed) | ChatView (flex-1)

**Modify:**
- `frontend/src/components/layout/AppLayout.tsx` -- selectedThreadId state, coordinate sidebar selection with chat view, handle create/delete thread events
- `frontend/src/App.tsx` -- ensure auth routing is correct

**Validation:** Full flow: login -> new chat -> send message -> create another thread -> switch between them -> delete thread -> all works

---

## Task 11: Error Handling + Polish
âœ… Simple

Loading states, error handling, markdown rendering, UX polish.

**Setup:** `npm install react-markdown` + `npx shadcn@latest add skeleton sonner`

**Frontend:**
- Loading skeletons for threads and messages
- Error toasts on API failures
- "Thinking..." indicator before first token
- Disable input while streaming
- Session expiry -> redirect to login
- Markdown rendering in assistant messages

**Backend:**
- Graceful HF API error handling (rate limits, model unavailable)
- Input validation (empty messages, non-existent threads)

**Validation:** Kill backend -> frontend shows error. Invalid HF token -> meaningful error. Rapid thread switching -> no crashes.

---

## Task 12: Final Validation + Progress Update
âœ… Simple

End-to-end checklist:

- [ ] Auth: signup, login, logout, session persistence, JWT rejection
- [ ] Threads: create, list, rename (auto-title), delete (cascade), RLS isolation
- [ ] Chat: optimistic user msg, streaming response, history maintained, persists on reload
- [ ] LangSmith: traces visible, correct input/output, nested spans
- [ ] RLS: two users see only their own data

**Modify:** `PROGRESS.md` -- mark Module 1 complete

---

## Dependency Graph

```
Task 1 (DB Schema)
  |
  v
Task 2 (Backend Scaffold) --> Task 3 (Auth Dependency)
  |                                  |
  v                                  v
Task 4 (Frontend + Auth UI)    Task 5 (Thread REST)
  |                                  |
  |                            Task 6 (HF Client + LangSmith)
  |                                  |
  |                            Task 7 (Chat Service + SSE)
  |                                  |
  v                                  v
Task 8 (Thread Sidebar) -----> Task 9 (Chat View + Streaming)
  |                                  |
  +--------> Task 10 (Layout) <------+
                  |
             Task 11 (Polish)
                  |
             Task 12 (Validation)
```

## Key Packages

**pip:** fastapi, uvicorn[standard], python-dotenv, pydantic, pydantic-settings, supabase, httpx, huggingface-hub, sse-starlette, PyJWT, langsmith

**npm:** @supabase/supabase-js, react-markdown, @tailwindcss/vite (dev)

**shadcn:** button, input, label, card, tabs, scroll-area, tooltip, textarea, avatar, skeleton, sonner
