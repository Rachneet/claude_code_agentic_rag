# Module 8: Additional Tools

## Complexity: ⚠️ Medium

## Context

The current tool system has one tool (`search_documents`) with a clean dispatcher pattern in `backend/app/chat/tools.py`. Tool-calling providers (Gemini/OpenRouter) already loop through `RAG_TOOLS` and call `execute_tool()` via a callback. Tools are currently only used when the user has uploaded documents. Module 8 adds four new tools and enables the tool-calling path even without documents.

**New tools:**
1. **Web search** — Tavily Search API for live web results (raw `httpx`, no SDK)
2. **Calculator** — `simpleeval` for safe math evaluation (no `eval()`)
3. **URL fetcher** — `httpx` + `BeautifulSoup` (both already installed) for web page reading
4. **Date/time** — stdlib `datetime` + `zoneinfo` for current time/timezone queries

No frontend changes. One new dependency (`simpleeval`).

---

## Tasks

### Task 1: Config settings
**Modify** `backend/app/config.py` — add after hybrid search settings:

```python
# Tool settings
tavily_api_key: str = ""
tools_web_search_enabled: bool = True
tools_calculator_enabled: bool = True
tools_url_fetcher_enabled: bool = True
tools_datetime_enabled: bool = True
url_fetcher_max_chars: int = 8000
url_fetcher_timeout: int = 15
```

**Modify** `backend/.env.example` — append:

```
# Additional Tools (Module 8)
TAVILY_API_KEY=your-tavily-api-key
TOOLS_WEB_SEARCH_ENABLED=true
TOOLS_CALCULATOR_ENABLED=true
TOOLS_URL_FETCHER_ENABLED=true
TOOLS_DATETIME_ENABLED=true
URL_FETCHER_MAX_CHARS=8000
URL_FETCHER_TIMEOUT=15
```

**Validate:** Backend boots with default values.

---

### Task 2: Add `simpleeval` dependency
**Modify** `backend/requirements.txt` — add `simpleeval`.

**Validate:** `pip install simpleeval` succeeds.

---

### Task 3: Create web search tool
**Create** `backend/app/chat/web_search.py`

- Async `web_search(query, max_results=5)` → formatted string
- Calls `https://api.tavily.com/search` via `httpx.AsyncClient`
- Sends `{"api_key": ..., "query": ..., "max_results": ..., "include_answer": True, "search_depth": "basic"}`
- Returns Tavily's answer + numbered results (title, URL, content snippet)
- If `tavily_api_key` is empty, returns "not configured" message
- `@traceable(name="web_search", run_type="tool")`
- On error: log warning, return error string (never raises)

---

### Task 4: Create calculator tool
**Create** `backend/app/chat/calculator.py`

- Async `calculate(expression)` → result string
- Uses `simpleeval.simple_eval` with whitelisted functions (sqrt, log, sin, cos, etc.) and constants (pi, e)
- AST-based fallback for basic arithmetic if simpleeval not installed
- `@traceable(name="calculate", run_type="tool")`
- Clean float formatting to avoid `0.30000000000000004`

---

### Task 5: Create URL fetcher tool
**Create** `backend/app/chat/url_fetcher.py`

- Async `fetch_url(url)` → extracted text string
- Uses `httpx.AsyncClient` (follow redirects, User-Agent) + `BeautifulSoup`
- Strips script, style, nav, footer, header, aside, iframe tags
- Truncates to `settings.url_fetcher_max_chars`
- Handles plain text/JSON responses directly (no HTML parsing)
- Extracts page `<title>` for context
- `@traceable(name="fetch_url", run_type="tool")`

---

### Task 6: Create date/time tool
**Create** `backend/app/chat/datetime_tool.py`

- Async `get_datetime(timezone_name="UTC")` → formatted string
- Uses stdlib `datetime` + `zoneinfo` (zero dependencies)
- Returns human-readable date, time, ISO format, and Unix timestamp
- On invalid timezone, suggests close matches from `available_timezones()`
- `@traceable(name="get_datetime", run_type="tool")`

---

### Task 7: Update tool registry and dispatcher
**Modify** `backend/app/chat/tools.py`

- Add four new tool declarations (Gemini-compatible function declaration format)
- Add `get_enabled_tools()` function that builds the list based on config flags
  - `search_documents` always included
  - `web_search` included only if flag enabled AND `tavily_api_key` is set
  - Others included if their flag is enabled
- `RAG_TOOLS = get_enabled_tools()` for backward compat
- Extend `execute_tool()` with new tool branches (lazy imports)
- Wrap entire `execute_tool()` in try/except for resilience

---

### Task 8: Update chat service for tool awareness
**Modify** `backend/app/chat/service.py`

Key changes:
1. Import `get_enabled_tools` instead of `RAG_TOOLS`
2. Replace static `RAG_SYSTEM_PROMPT` with `_build_rag_system_prompt()` that dynamically describes all enabled tools
3. **Change the tool-path condition** (line 136): currently `has_documents and provider.supports_tools`. New logic:

```python
enabled_tools = get_enabled_tools()
has_non_rag_tools = len(enabled_tools) > 1

if provider.supports_tools and (has_documents or has_non_rag_tools):
    # Tool-calling path with all enabled tools
    ...
elif has_documents:
    # HF context injection (unchanged)
    ...
else:
    # Standard chat (unchanged)
    ...
```

This lets the LLM use calculator, web search, datetime, and URL fetcher even when the user has no uploaded documents.

---

### Task 9: Update PROGRESS.md

---

## Files Summary

| File | Action |
|------|--------|
| `backend/app/config.py` | Modify (7 settings) |
| `backend/.env.example` | Modify (7 env vars) |
| `backend/requirements.txt` | Modify (add simpleeval) |
| `backend/app/chat/web_search.py` | **Create** |
| `backend/app/chat/calculator.py` | **Create** |
| `backend/app/chat/url_fetcher.py` | **Create** |
| `backend/app/chat/datetime_tool.py` | **Create** |
| `backend/app/chat/tools.py` | Modify (4 declarations, dynamic builder, extended dispatcher) |
| `backend/app/chat/service.py` | Modify (dynamic prompt, tools without documents) |
| `PROGRESS.md` | Modify |

## Verification
1. Boot with no new env vars — should start without errors, 4 tools available (web search excluded since no API key)
2. Calculator: "What is sqrt(2)^10?" → LLM calls `calculate`, returns `32`
3. Date/time: "What time is it in Tokyo?" → LLM calls `get_datetime` with `Asia/Tokyo`
4. URL fetcher: "Summarize https://example.com" → LLM calls `fetch_url`
5. Web search (with `TAVILY_API_KEY`): "Latest AI news" → calls `web_search`
6. Combined: upload doc + ask "What does my doc say about X? Also, what is 2+2?" → both `search_documents` and `calculate` called
7. HuggingFace provider: still works via context injection path
8. LangSmith: all tool calls appear as traced spans
9. Disable flags: `TOOLS_CALCULATOR_ENABLED=false` → `calculate` not in tools list
