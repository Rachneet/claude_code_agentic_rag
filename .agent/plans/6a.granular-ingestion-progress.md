# Stage-Based Ingestion Progress

## Complexity: ✅ Simple

## Context

When uploading files (especially PDFs), the document sits at "pending"/"processing" with no visibility into what's happening. The pipeline has 4 distinct stages (extract → chunk → metadata/embed → done) but only reports `processing` → `completed`. We'll add granular status values so the UI shows exactly which stage is running.

## Current Flow

```
pending → processing → completed/failed
```

## New Flow

```
pending → extracting → chunking → embedding → completed/failed
```

The `processing` status is removed — replaced by the three granular stages. The `embedding` stage covers both metadata extraction and embedding generation since they happen together and embedding is the slow part.

---

## Tasks

### Task 1: SQL migration — expand status CHECK constraint
**Create** `backend/supabase/migrations/006_granular_status.sql`

```sql
ALTER TABLE public.documents
  DROP CONSTRAINT IF EXISTS documents_status_check,
  ADD CONSTRAINT documents_status_check
    CHECK (status IN ('pending', 'extracting', 'chunking', 'embedding', 'completed', 'failed'));
```

Drop old constraint, add new one with 3 granular statuses replacing `processing`.

### Task 2: Update backend service with granular statuses
**Modify** `backend/app/ingestion/service.py`

Replace the single `update_document_status(doc_id, "processing")` call with stage-specific calls at each pipeline step:

- Before text extraction: `update_document_status(doc_id, "extracting")`
- Before chunking: `update_document_status(doc_id, "chunking")`
- Before embedding generation: `update_document_status(doc_id, "embedding")`
- `completed` and `failed` calls stay the same

### Task 3: Update frontend types
**Modify** `frontend/src/types/index.ts`

Change status union from:
```ts
status: "pending" | "processing" | "completed" | "failed"
```
to:
```ts
status: "pending" | "extracting" | "chunking" | "embedding" | "completed" | "failed"
```

### Task 4: Update StatusBadge with step indicator
**Modify** `frontend/src/components/documents/DocumentList.tsx`

Replace the `StatusBadge` switch-case with a step indicator for processing stages. When status is `extracting`, `chunking`, or `embedding`:

Show a compact step indicator like:
```
[✓ Extract] → [⟳ Chunk] → [○ Embed]
```

- Completed steps: checkmark, green text
- Current step: spinner, blue text
- Future steps: muted text

Keep existing `pending`, `completed`, `failed` badges as-is. Remove the `processing` case.

### Task 5: Update PROGRESS.md

---

## Files Summary

| File | Action |
|------|--------|
| `backend/supabase/migrations/006_granular_status.sql` | **Create** |
| `backend/app/ingestion/service.py` | Modify (3 status calls) |
| `frontend/src/types/index.ts` | Modify (status union) |
| `frontend/src/components/documents/DocumentList.tsx` | Modify (StatusBadge → step indicator) |
| `PROGRESS.md` | Modify |

## Verification
1. Run SQL migration 006 in Supabase
2. Upload a file — watch status cycle through `extracting → chunking → embedding → completed` in the UI
3. Each stage should show the step indicator with correct current/completed/pending styling
4. Failed uploads should still show the red "Failed" badge with error message
5. Completed uploads should still show green "Completed" badge with chunk count and metadata
